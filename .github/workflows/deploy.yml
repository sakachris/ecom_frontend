name: Deploy to Kubernetes

on:
  push:
    branches: [staging, main]

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Select environment vars
        id: env-select
        run: |
          if [[ "${GITHUB_REF_NAME}" == "staging" ]]; then
            echo "ENV_SUFFIX=staging" >> $GITHUB_OUTPUT
            echo "API_URL=${{ secrets.NEXT_PUBLIC_API_URL_STAGING }}" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "ENV_SUFFIX=production" >> $GITHUB_OUTPUT
            echo "API_URL=${{ secrets.NEXT_PUBLIC_API_URL_PRODUCTION }}" >> $GITHUB_OUTPUT
          fi

      - name: Build & push Docker image
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            sakachris/ecom-frontend:${{ steps.env-select.outputs.ENV_SUFFIX }}-${{ github.sha }}
            sakachris/ecom-frontend:latest-${{ steps.env-select.outputs.ENV_SUFFIX }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ steps.env-select.outputs.API_URL }}

      - name: Set up kubectl
        if: success()
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          kubectl get nodes

      - name: Deploy to Kubernetes
        if: success()
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          if [[ "${GITHUB_REF_NAME}" == "staging" ]]; then
            DEPLOY=ecom-frontend-staging
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            DEPLOY=ecom-frontend
          fi

          kubectl set image deployment/$DEPLOY \
            $DEPLOY=sakachris/ecom-frontend:${{ steps.env-select.outputs.ENV_SUFFIX }}-${{ github.sha }} \
            -n ecom-api

          kubectl rollout restart deployment $DEPLOY -n ecom-api
          kubectl rollout status deployment $DEPLOY -n ecom-api

      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          # subject: "✅ Deployment Successful (${GITHUB_REF_NAME})"
          subject: "✅ Deployment Successful (${{ github.ref_name }})"
          # subject: "✅ Deployment Successful (${{ steps.yourstep.outputs.ENV_SUFFIX }})"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: "Deployment Bot <${{ secrets.EMAIL_USERNAME }}>"
          secure: true
          body: |
            Deployment to ${{ steps.yourstep.outputs.ENV_SUFFIX }} succeeded.
            Docker tags:
              latest-${{ steps.env-select.outputs.ENV_SUFFIX }}
              ${{ steps.env-select.outputs.ENV_SUFFIX }}-${{ github.sha }}
            Deployment restarted.
            Commit: ${{ github.sha }}
            Timestamp: ${{ github.event.head_commit.timestamp }}

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "❌ Deployment Failed (${{ steps.yourstep.outputs.ENV_SUFFIX }})"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: "Deployment Bot <${{ secrets.EMAIL_USERNAME }}>"
          secure: true
          body: |
            Deployment to ${{ steps.yourstep.outputs.ENV_SUFFIX }} failed.
            Check logs here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Commit: ${{ github.sha }}
            Timestamp: ${{ github.event.head_commit.timestamp }}
